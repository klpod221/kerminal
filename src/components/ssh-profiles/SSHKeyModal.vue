<template>
  <Modal id="ssh-key-modal" :title="modalTitle" size="lg">
    <Form ref="keyForm" @submit="handleSubmit">
      <!-- Edit mode info -->
      <div
        v-if="keyId"
        class="mb-4 p-3 bg-blue-900/20 border border-blue-700 rounded-lg"
      >
        <p class="text-sm text-blue-300">
          <strong>Edit Mode:</strong> Key fields are empty for security. Only
          fill them if you want to update the key data.
        </p>
      </div>

      <Input
        id="key-name"
        v-model="formData.name"
        label="Key Name"
        placeholder="My SSH Key"
        rules="required"
      />

      <Textarea
        id="private-key"
        v-model="formData.privateKey"
        label="Private Key"
        placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----"
        :rows="8"
        :rules="keyId ? '' : 'required'"
      />

      <!-- Import from file button below textarea -->
      <div class="flex gap-2 mb-2">
        <Input
          id="file-path"
          v-model="selectedFileName"
          placeholder="No file selected"
          :disabled="true"
          class="flex-1"
        />
        <Button
          type="button"
          class="h-fit"
          variant="secondary"
          :icon="Upload"
          @click="selectKeyFile"
        >
          Import from File
        </Button>
      </div>
      <input
        ref="fileInput"
        type="file"
        class="hidden"
        @change="handleFileSelect"
      />

      <Textarea
        id="public-key"
        v-model="formData.publicKey"
        label="Public Key (Optional)"
        placeholder="ssh-rsa AAAAB3NzaC1yc2EA..."
        :rows="3"
      />

      <Input
        id="passphrase"
        v-model="formData.passphrase"
        label="Passphrase (Optional)"
        type="password"
        placeholder="Enter passphrase if key is protected"
      />

      <Textarea
        id="description"
        v-model="formData.description"
        label="Description (Optional)"
        placeholder="Additional notes about this key"
        :rows="2"
      />
    </Form>

    <template #footer>
      <div class="flex justify-end gap-2">
        <Button variant="secondary" @click="closeOverlay('ssh-key-modal')"
          >Cancel</Button
        >
        <Button
          variant="primary"
          :loading="isLoading"
          :icon="Save"
          @click="handleSubmit"
        >
          {{ submitButtonText }}
        </Button>
      </div>
    </template>
  </Modal>
</template>

<script setup lang="ts">
import { ref, computed, watch } from "vue";
import Modal from "../ui/Modal.vue";
import Form from "../ui/Form.vue";
import Input from "../ui/Input.vue";
import Textarea from "../ui/Textarea.vue";
import Button from "../ui/Button.vue";
import { Save, Upload } from "lucide-vue-next";
import { useSshKeyStore } from "../../stores/sshKey";
import { useOverlay } from "../../composables/useOverlay";
import { message } from "../../utils/message";

const props = defineProps<{
  keyId?: string | null;
}>();

const sshKeyStore = useSshKeyStore();
const { closeOverlay, getOverlayProp } = useOverlay();

const keyId = getOverlayProp("ssh-key-modal", "keyId", props.keyId, null);

const keyForm = ref<InstanceType<typeof Form> | null>(null);
const isLoading = ref(false);
const fileInput = ref<HTMLInputElement | null>(null);
const selectedFileName = ref("");

const formData = ref({
  name: "",
  privateKey: "",
  publicKey: "",
  passphrase: "",
  description: "",
});

const modalTitle = computed(() =>
  keyId.value ? "Edit SSH Key" : "Add SSH Key",
);

const submitButtonText = computed(() => {
  if (keyId.value) return "Update Key";
  return "Add Key";
});

const selectKeyFile = () => {
  fileInput.value?.click();
};

const handleFileSelect = (event: Event) => {
  const target = event.target as HTMLInputElement;
  const file = target.files?.[0];
  if (!file) return;

  selectedFileName.value = file.name;

  const reader = new FileReader();
  reader.onload = (e) => {
    const content = e.target?.result as string;
    formData.value.privateKey = content;
  };
  reader.onerror = () => {
    message.error("Failed to read file");
    selectedFileName.value = "";
  };
  reader.readAsText(file);
};

const handleSubmit = async () => {
  const isValid = await keyForm.value?.validate();
  if (!isValid) return;

  isLoading.value = true;

  try {
    if (keyId.value) {
      const updateRequest: any = {
        name: formData.value.name,
        description: formData.value.description || undefined,
      };

      if (formData.value.privateKey.trim()) {
        updateRequest.privateKey = formData.value.privateKey;
      }
      if (formData.value.publicKey.trim()) {
        updateRequest.publicKey = formData.value.publicKey;
      }
      if (formData.value.passphrase.trim()) {
        updateRequest.passphrase = formData.value.passphrase;
      }

      await sshKeyStore.updateKey(keyId.value, updateRequest);
      message.success("SSH key updated successfully");
    } else {
      await sshKeyStore.createKey({
        name: formData.value.name,
        privateKey: formData.value.privateKey,
        publicKey: formData.value.publicKey || undefined,
        passphrase: formData.value.passphrase || undefined,
        description: formData.value.description || undefined,
      });
      message.success("SSH key created successfully");
    }

    closeModal();
  } catch (error) {
    console.error("Error saving SSH key:", error);
  } finally {
    isLoading.value = false;
  }
};

const loadKey = async () => {
  if (!keyId.value) return;

  isLoading.value = true;
  try {
    await sshKeyStore.loadKeys();
    const key = sshKeyStore.keys.find((k) => k.id === keyId.value);

    if (key) {
      formData.value = {
        name: key.name,
        privateKey: "", // Keep empty to avoid showing encrypted data
        publicKey: "", // Keep empty unless user wants to update
        passphrase: "", // Keep empty unless user wants to update
        description: key.description || "",
      };
    }
  } catch (error) {
    console.error("Error loading SSH key:", error);
    message.error("Failed to load SSH key");
  } finally {
    isLoading.value = false;
  }
};

const closeModal = () => {
  formData.value = {
    name: "",
    privateKey: "",
    publicKey: "",
    passphrase: "",
    description: "",
  };
  closeOverlay("ssh-key-modal");
};

watch(
  keyId,
  (newKeyId) => {
    if (newKeyId) {
      loadKey();
    } else {
      formData.value = {
        name: "",
        privateKey: "",
        publicKey: "",
        passphrase: "",
        description: "",
      };
      selectedFileName.value = "";
    }
  },
  { immediate: true },
);
</script>
